.PHONY: help start stop db-up db-down migrate backend test clean setup

# Database config
DB_NAME=cloak_db
DB_USER=postgres
DB_PASS=postgres
DB_PORT=5432
DB_HOST=localhost
CONTAINER_NAME=postgres-cloak

help:
	@echo "=== CLOAK Backend - Quick Commands ==="
	@echo ""
	@echo "Quick Start:"
	@echo "  make start       - Start everything (db + migrations + backend)"
	@echo "  make stop        - Stop database"
	@echo ""
	@echo "Database:"
	@echo "  make db-up       - Start PostgreSQL container"
	@echo "  make db-down     - Stop PostgreSQL container"
	@echo "  make db-shell    - Open PostgreSQL shell"
	@echo ""
	@echo "Setup & Migration:"
	@echo "  make setup-env   - Create .env file"
	@echo "  make migrate     - Run database migrations"
	@echo ""
	@echo "Backend:"
	@echo "  make backend     - Start API server"
	@echo "  make build       - Build binary"
	@echo ""
	@echo "Testing:"
	@echo "  make test        - Test health endpoint"
	@echo ""
	@echo "Cleanup:"
	@echo "  make clean       - Remove build artifacts"
	@echo ""

# ============ QUICK START ============

start: db-up migrate backend
	@echo "Starting everything..."

stop: db-down
	@echo "Stopped"

# ============ DATABASE ============

db-up:
	@echo "Starting PostgreSQL..."
	@docker run -d --name $(CONTAINER_NAME) \
		-e POSTGRES_USER=$(DB_USER) \
		-e POSTGRES_PASSWORD=$(DB_PASS) \
		-e POSTGRES_DB=$(DB_NAME) \
		-p $(DB_PORT):5432 \
		postgres:16 2>/dev/null || echo "Container already running"
	@echo "PostgreSQL started on localhost:$(DB_PORT)"
	@sleep 5

db-down:
	@echo "Stopping PostgreSQL..."
	@docker stop $(CONTAINER_NAME) 2>/dev/null
	@docker rm $(CONTAINER_NAME) 2>/dev/null
	@echo "PostgreSQL stopped"

db-clean:
	@echo "Removing PostgreSQL container and data..."
	@docker stop $(CONTAINER_NAME) 2>/dev/null
	@docker rm $(CONTAINER_NAME) 2>/dev/null
	@echo "PostgreSQL cleaned"

db-shell:
	@docker exec -it $(CONTAINER_NAME) psql -U $(DB_USER) -d $(DB_NAME)

db-logs:
	@docker logs -f $(CONTAINER_NAME)

# ============ SETUP ============

setup-env:
	@echo "Creating .env file..."
	@echo "PORT=8080" > .env
	@echo "ENVIRONMENT=development" >> .env
	@echo "DATABASE_URL=postgres://postgres:postgres@localhost:5432/cloak_db?sslmode=disable" >> .env
	@echo "JWT_SECRET=dev-secret-key-change-in-production" >> .env
	@echo "HMAC_SECRET=dev-hmac-secret-change-in-production" >> .env
	@echo ".env created!"

# ============ MIGRATIONS ============

migrate:
	@echo "Running migrations..."
	@migrate -path migrations -database "postgres://$(DB_USER):$(DB_PASS)@$(DB_HOST):$(DB_PORT)/$(DB_NAME)?sslmode=disable" up
	@echo "Migrations complete!"

migrate-down:
	@echo "Rolling back migrations..."
	@migrate -path migrations -database "postgres://$(DB_USER):$(DB_PASS)@$(DB_HOST):$(DB_PORT)/$(DB_NAME)?sslmode=disable" down

# ============ BACKEND ============

backend:
	@echo "Starting CLOAK Backend on http://localhost:8080"
	@./bin/api

build:
	@echo "Building backend..."
	@go build -o bin/api ./cmd/api
	@echo "Build complete!"

rebuild: clean build

# ============ TESTING ============

test:
	@echo "Testing health endpoint..."
	@curl -s http://localhost:8080/health | jq . || echo "Backend not running"

test-register:
	@echo "Testing registration..."
	@curl -s -X POST http://localhost:8080/api/v1/auth/business/register \
		-H "Content-Type: application/json" \
		-d '{"name":"Test","email":"test@test.com","password":"pass123"}' | jq .

test-login:
	@echo "Testing login..."
	@curl -s -X POST http://localhost:8080/api/v1/auth/business/login \
		-H "Content-Type: application/json" \
		-d '{"email":"test@test.com","password":"pass123"}' | jq .

# ============ CLEANUP ============

clean:
	@echo "Cleaning build artifacts..."
	@rm -rf bin/
	@echo "Cleaned!"

all-down:
	@echo "Stopping everything..."
	@docker stop $(CONTAINER_NAME) 2>/dev/null
	@docker rm $(CONTAINER_NAME) 2>/dev/null
	@rm -rf bin/
	@echo "Everything stopped and cleaned"
